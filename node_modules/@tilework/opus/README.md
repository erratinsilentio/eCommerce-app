<h1 float="left">
    <img src="https://e.unicode-table.com/orig/f5/7c6daba899f1db0c849b20fae63a38.png" height="32">
    Opus
</h1>


*Opus*, the Latin for ‘work’, is the way in which the pieces of a tilework are cut and placed.

## Why

<h4 float="left"> 
    <img src="https://e.unicode-table.com/orig/76/82f32524fb743dbc62cd86fba89f6e.png" height="20">
    Make your requests extensible
</h4>

The GraphQL requests generated by this library are easily extensible by [the plugin system](https://github.com/tilework/mosaic), because they are generated procedurally, as opposed to the commonly-used generation from strings.


<h4 float="left"> 
    <img src="https://e.unicode-table.com/orig/40/2824a7079418328ff8a74ab2d92441.png" height="20">
    Stay lightweight
</h4>

This library is TINY and still provides all of the basic functionality of GraphQL interactions. Additional features are planned to get implemented on-demand.

<h4 float="left"> 
    <img src="https://e.unicode-table.com/orig/a0/d616e234deff52663bbb0d263b1a18.png" height="20">
    Definitely typed
</h4>

Generate GraphQL requests with Builder pattern and receive properly structurally typed responses upon fetching!

![Hnet com-image](https://user-images.githubusercontent.com/46347627/113285078-304d1b80-92f3-11eb-91f4-c7a491a39996.gif)

## What

<h4 float="left"> 
    <img src="https://e.unicode-table.com/orig/41/afffcb1f4ba527f67325f094febfb1.png" height="20">
    Building fields
</h4>

Almost every aspect of GraphQL functionality is supported: fields, nested fields, inline fragments, arguments.
The only thing not yet supported are non-inline Fragments. Although, apart from slightly increased request size, this will not impact your development experience in any way.

```js
import { Query, Field, InlineFragment } from '@tilework/opus';

const dragonFields = ['name', 'neck_length', 'age'] as const;

const dragonsQuery = new Query('dragons', true) // `true` means 'expect array'
    .addArgument('limit', 'Int', 5)
    .addFieldList(dragonFields)
    .addField(new Field('children', true)
        .addFieldList(dragonFields)
    )
    .addField(new InlineFragment('Fire')
        .addField('fire_temperature')
    )
    .addField(new InlineFragment('Ice')
        .addField('ice_density')
    )
```

<h4 float="left"> 
    <img src="https://e.unicode-table.com/orig/41/afffcb1f4ba527f67325f094febfb1.png" height="20">
    Getting data type from a field
</h4>

Sometimes it is necessary to explicitly reference the type, which the fetched data will have upon retrieval. A utility type is provided in order to make this possible!

```js
import { Query } from '@tilework/opus';
import type { DataType } from '@tilework/opus';

const query = new Query('person', true)
    .addFieldList(['name', 'surname']);

let result: DataType<typeof query>;

result = await client.post(query);
```

<h4 float="left">
    <img src="https://e.unicode-table.com/orig/c6/067075f73e5891479108c2d51d0ff7.png" height="20">
    Calculated fields
</h4>

An opportunity to derive additional data from the fetched information is provided with calculated fields. A calculated field can be added on any instance of `Field`, `Query` or `Mutation`. 

Such fields get calculated once, when the request is post-processed upon fetching. They are calculated starting with the deepest child and going up to the root node (post-visit).

```js
import { Query, Field } from '@tilework/opus';

const query = new Query('dragons', true)
    .addField('active')
    .addField(new Field('launch_payload_mass')
        .addField('kg')
        .addCalculatedField('lb', (result) => result.kg * ONE_KG_IN_LBS)
    )
    .addField(new Field('return_payload_mass')
        .addField('kg')
    )
    .addCalculatedField('payload_delta_kg', (result) => {
        return result.launch_payload_mass.kg - result.return_payload_mass.kg;
    });
```

<h4 float="left">
    <img src="https://e.unicode-table.com/orig/27/c5ae0c9c67e5e0e55537665aa89576.png" height="20">
    Client-side transformations
</h4>

> **Note:** Attempts to add fields to the result via this API will throw due to the processable object being sealed at the time of processing. Use calculated fields to add additional fields.

Sometimes it's necessary to modify the data you have received, e.g. in order to reduce nesting of some fields. In order to achieve that, this functionality should be used!

In the example below, the property `launch_payload_mass` becomes `launch_payload_mass.kg`, just to make everything a bit more convenient.

```js
import { Query, Field } from '@tilework/opus';

const query = new Query('dragons', true)
    .addField('active')
    .addField(new Field('launch_payload_mass')
        .addField('kg')
        .addTransformation((launchPayload) => launchPayload.kg)
    )
    .addField(new Field('return_payload_mass')
        .addField('kg')
        .addTransformation((returnPayload) => returnPayload.kg)
    );

...

typeof result.dragons[0].launch_payload_mass; // number
```

<h4 float="left">
    <img src="https://e.unicode-table.com/orig/be/f154b24d3532e67d8d943112e5b931.png" height="20">
    Fetching some requests!
</h4>

The `client` provides an opportunity to fetch queries and mutations, as well as fetch combined queries and combined mutations.

```js
import { client, CombinedField } from '@tilework/opus';

// Single requests
const queryResult = await client.post(someQuery);
const mutationResult = await client.post(someMutation);

// Combined queries and mutations work the same
const combinedQueryResult = await client.post(new CombinedField
    .add(firstQuery)
    .add(secondQuery)
);
```

<h4 float="left">
    <img src="https://e.unicode-table.com/orig/a2/7591b29cce40dd113708ef2117fe88.png" height="20">
    Configuring the client
</h4>

It is necessary to set up the client before fetching any data. See the required configuration steps below.

-  Endpoint
   -  `client.setEndpoint(endpoint: string)` allows to configure this in runtime 
   -  Setting `GRAPHQL_ENDPOINT` in `process.env` will also set the endpoint
   -  It defaults to `/graphql`
-  Headers
   -  `client.setHeaders(headers: any)` will set the headers to use for fetching requests